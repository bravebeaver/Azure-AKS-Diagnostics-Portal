<div class="category-container">
  <h2>AKS Periscope</h2>
  <p class="category-description">
    AKS Periscope allows AKS customers to collect and export the logs into an Azure Blob storage account
    to help analyze and identify potential problems or easily share the information to support to help 
    with the troubleshooting process. 
    <a target="_blank" rel="noopener" href="https://github.com/Azure/aks-periscope">Learn more</a>
  </p>

  <h3>What you should know before using runCommand </h3>
  <ul>
      <li>The runCommand is only available for AKS clusters with Azure AD enabled.
        <a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/azure/aks/command-invoke">Learn more</a>
      </li>
  </ul>

  <h3>Work in Progress setup to get started </h3>
  <ul>
    <li> The periscope logs are stored in Azure Storage. To get started, we use storage account from your choice, before integrating with other Azure components gradually.</li>
    
    <li>
      please append the following variable in <code>environment.local.ts</code>(from readme.md). 
      <pre>
        <code class="language-json">

            ...
            authServiceResourceId: "",
            storageAccountName: 'xx',
            blobContainerName: 'xx',
            sasUri: '?your-sas-token', //the question mark is required
        </code>
      </pre>

      you can create <code>your-sas-token</code> using the following command:
      <pre>
        <code class="language-bash">
        export storageAccountName='xx'
        export subscriptionId='xx'
        sas_expiry=`date -u -d "30 minutes" '+%Y-%m-%dT%H:%MZ'`
        sas=$(az storage account generate-sas \
            --account-name $storageAccountName \
            --subscription $subscriptionId \
            --permissions rlacw \
            --services b \
            --resource-types sco \
            --expiry $sas_expiry \
            -o tsv)
        </code>
      </pre>
    </li>
  </ul>

  <div *ngIf="status == toolStatus.Loading; else runningStatus">
    <i class="fa fa-circle-o-notch fa-spin spin-icon" aria-hidden="true"></i>
  {{ statusMessage }}
  </div>

  <ng-template #runningStatus>
    <ul>
      <li *ngFor="let statusUpdate of diagnosticToolRunningStatus">{{ statusUpdate }}</li>
    </ul>
  </ng-template>

  <div style="margin-top: 40px;">
    <collapsible-list-fabric [title]="'Configure'">

      <!--configure periscope run-->
      <collapsible-list-item body>
        <div class="container">
          <div>
            <div class="row mt-4">
              <div class="row">
                <div class="col-md-3 field-label"> Diagnotisc RunId <span class="required">*</span>
                  <fab-tooltip-host content="The identifier for a particular 'run' of Periscope. This will become the topmost container within the container name"
                    [directionalHint]="directionalHint" [tooltipOptions]="toolTipOptionsValue">
                    <img src="assets/img/info.svg" title="info" />
                  </fab-tooltip-host>
                </div>
                <div class="col-md-2">
                  <input type="text" aria-required="false" placeholder="e.g. 2023-12-12T15-20-20Z" [(ngModel)]="periscopeConfig.diagnosticRunId"/>
                </div>  
              </div>
              <div class="col-md-3 field-label"> Storage account <span class="required">*</span>
                <fab-tooltip-host
                  content="The selected storage account will store the logs captured via AKS periscope. You can choose to use a storage account resource you own, 
                  or an account with a shared access signature token"
                  [directionalHint]="directionalHint" [tooltipOptions]="toolTipOptionsValue">
                  <img src="assets/img/info.svg" title="storage-account"/>
                </fab-tooltip-host>
                <div class="col-md-2">
                  {{ storageConfig | json }} 
                </div>  
              </div>
              <!-- <div class="col-md-2">
                <span> {{ storageAccountName }} </span>
                <div class="mt-1 mb-4" (click)="toggleStorageAccountPanel()" (keyup.enter)="toggleStorageAccountPanel()">
                  <a tabindex="0" role="button" name="Change storage account" aria-label="Change storage account">
                    {{ storageAccountName != null && storageAccountName.length > 0  ? 'Change' : 'Select' }}</a>
                </div>
              </div> -->
            </div>
          </div>

          <div class="row" *ngIf=" errorMessage ">
            <div class="col-md-6 error-details">
              <i class="fa health-icon fa-times-circle unhealthy-icon-color" aria-hidden="true"></i>
              <span *ngIf="errorMessage">{{ errorMessage}}</span> &nbsp;<span *ngIf="error">{{ error}}</span>
            </div>
          </div>

          <div class="mt-3 ml-3">
            <fab-primary-button [contentStyle]="'margin-right:10px;float:left'" [disabled]="!validConfiguration && status == toolStatus.Loading" (onClick)="runInClusterPeriscope()">
              Run AKS periscope
            </fab-primary-button>
          </div>
                <!--TODO list existing periscope runs -->
        </div>
      </collapsible-list-item>

    </collapsible-list-fabric>
  </div>
</div>
