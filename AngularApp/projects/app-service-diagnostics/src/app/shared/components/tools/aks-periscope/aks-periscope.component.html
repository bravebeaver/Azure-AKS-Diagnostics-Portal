<div class="container">
  <h2 tabindex="0">AKS Periscope</h2>
  <p class="category-description" tabindex="0">
    AKS Periscope allows AKS customers to collect and export the logs into an Azure Blob storage account
    to help analyze and identify potential problems or easily share the information to support to help 
    with the troubleshooting process. 
    <a target="_blank" rel="noopener" href="https://github.com/Azure/aks-periscope">Learn more</a>
  </p>
  
  <p>
    The diagnostic tool uses <code>runCommand</code> which is only available for AKS clusters with Azure AD enabled.
    <a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/azure/aks/command-invoke">Learn more</a>
  </p>

  <p>
    Periscope requires a storage account to store the logs. If you do not own the storage account, you can specify a SAS token. The SAS token for your storage account using the Azure portal or Azure CLI.
    <span style="margin-top:5px"><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/azure/storage/common/storage-sas-overview">Learn more</a></span>
  </p>
  
  <p>
    Read our data privacy statement here.
    <a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/azure/aks/command-invoke">Learn more</a>
  </p>

  <div style="margin-top:10px;margin-bottom: 5px">
    <div *ngIf="status == toolStatus.Loading">
      <i class="fa fa-circle-o-notch fa-spin spin-icon" aria-hidden="true">Running </i>
    </div>
    <div *ngIf=" status == toolStatus.Error">
      <i class="fa health-icon fa-times-circle unhealthy-icon-color" aria-hidden="true">Error</i>
    </div>
    <div>
      <ul>
        <li *ngFor="let toolMessage of toolMessages">{{ toolMessage }}</li>
      </ul> 
    </div>
  </div>  

  <collapsible-list-fabric [collapsed]="false" title="Configure new Session">
    <!--configure periscope run-->
    <collapsible-list-item body>
      <div class="container">
        <div class="row">
          <div class="col-md-3 field-label"> Storage account Name <span class="required">*</span>
            <fab-tooltip-host
              content="The selected storage account will store the logs captured via AKS periscope. You can choose to use a storage account resource you own, 
              or an account with a shared access signature token"
              [directionalHint]="directionalHint" [tooltipOptions]="toolTipOptionsValue">
              <img src="assets/img/info.svg" title="storage-account"/>
            </fab-tooltip-host>
            <div class="col-md-4 col-sm-4">
              <input aria-required="true" placeholder="storage account name" [(ngModel)]="storageConfig.resourceName">
              <span style="color:red">*</span>
              <div *ngIf="storageConfig.resourceName !== null && !isValidStorageConfig()" class="alert alert-danger" role="alert" style="margin-top:5px">
                The storage account is required.
              </div>
            </div>
          </div>
        </div>
        <div class="row">
          <div class="col-md-3 field-label"> Storage Account SAS Key
            <fab-tooltip-host content="If you do not own the storage account specified above, you can specify a SAS token to access the storage account."
              [directionalHint]="directionalHint" [tooltipOptions]="toolTipOptionsValue">
              <img src="assets/img/info.svg" title="info" />
            </fab-tooltip-host>
          </div>
          <div class="col-md-5 col-sm-4">
            <input aria-required="false" placeholder="sas token" [(ngModel)]="storageConfig.accountSasToken">
          </div>
        </div>
        <div class="row">
          <div class="col-md-3 field-label"> Container Name <span class="required">*</span>
            <fab-tooltip-host content="The blob container to store the logs of Periscope."
              [directionalHint]="directionalHint" [tooltipOptions]="toolTipOptionsValue">
              <img src="assets/img/info.svg" title="info" />
            </fab-tooltip-host>
          </div>
          <div class="col-md-5 col-sm-4">
            <input aria-required="true" placeholder="blob container name" [(ngModel)]="containerName">
            <span style="color:red">*</span>
            <div *ngIf="containerName !== null && !isValidStorageConfig()" class="alert alert-danger" role="alert" style="margin-top:5px">
              The container will be created if not exist already.
            </div>
          </div>
        </div>  
        <div class="row">
          <div class="col-md-3 field-label">Diagnostic RunId <span class="required">*</span>
            <fab-tooltip-host content="The ID of the run. It should be unique per Periscope deployment."
              [directionalHint]="directionalHint" [tooltipOptions]="toolTipOptionsValue">
              <img src="assets/img/info.svg" title="info" />
            </fab-tooltip-host>
          </div>
          <div class="col-md-5 col-sm-4">
            <input aria-required="true" placeholder="e.g., YYYY-DD-MMTHH:mm:SS" [(ngModel)]="diagnosticRunId">
          </div>
        </div>  <!--TODO list existing periscope runs -->
      </div>
      <div class="mt-3 ml-3">
        <fab-primary-button [contentStyle]="'margin-right:10px;float:left'" [disabled]="!isValidStorageConfig() || isProcessingNewSession()" (onClick)="runInClusterPeriscope()">
          {{!isValidStorageConfig() || isProcessingNewSession() ? 'Submitting session to cluster' : 'Run Periscope in Cluster'  }}
        </fab-primary-button>
      </div>
    </collapsible-list-item>
  </collapsible-list-fabric>

  <collapsible-list-fabric [collapsed]="periscopeSessions.length === 0" title="Historical Sessions">
    <collapsible-list-item body>
      <div class="container">
        <div class="row">
          <div class="col-md-9">
            <div *ngIf="periscopeSessions.length === 0 else toolSessions">
              <fab-tooltip-host content="Only sessions available to AKS are displayed here" [directionalHint]="directionalHint" [tooltipOptions]="toolTipOptionsValue">
                No known sessions.
              </fab-tooltip-host>
            </div>

            <ng-template #toolSessions>
              <table class="table table-borderless">
                <thead>
                  <tr>
                    <th tabindex="0">Runtime/ Diagnostic Id</th>
                    <th tabindex="0">Running Status</th>
                    <th tabindex="0">View in Blob Container</th>
                    <th tabindex="0">Open in Storage Explorer</th>
                  </tr>
                </thead>
                <tbody>
                  <tr *ngFor="let session of periscopeSessions">
                    <td tabindex="0"> {{ session.config.diagnosticRunId }} </td>
                    <td>
                      <div *ngIf="session.status == sessionStatus.Running">
                        <i class="fa fa-spinner fa-spin"></i> Running...
                      </div>
                      <div *ngIf="(session.status == sessionStatus.Error || session.status == sessionStatus.Abandoned)">
                        <i class="fa health-icon fa-times-circle unhealthy-icon-color" aria-hidden="true"></i>
                        <span> Timeout retrieving runCommand status. The job might still be running</span>
                      </div>
                      <div *ngIf="(session.status == sessionStatus.Finsihed)">
                        <i class="fa health-icon fa-times-circle unhealthy-icon-color" aria-hidden="true"></i>
                        <span> Completed</span>
                      </div>
                      <div *ngIf="(session.status != sessionStatus.Running && session.status != sessionStatus.Created)" (click)="getPeriscopeLogs(session)">
                        <a tabindex="0" aria-label="view logs"> Get logs </a> 
                      </div>
                    </td>
                    <td>
                      <div *ngIf="(session.status != sessionStatus.Running && session.status != sessionStatus.Created)" (click)="openStorageContainerBlade(session)">
                        <a tabindex="0" aria-label="view result">{{ session.config.containerName }} </a>
                      </div>
                    </td>
                    <td>
                      <div *ngIf="session.status == sessionStatus.Finished || session.status == sessionStatus.Abandoned ">
                        <a tabindex="0" aria-label="view result" [href]="session.resultHref"> Copy Link </a>
                      </div>
                    </td>
                  </tr>
                </tbody>
              </table>
            </ng-template>
          </div>
        </div>
      </div>
    </collapsible-list-item>
  </collapsible-list-fabric>

  <collapsible-list-fabric [collapsed]="clusterMessages.length == 0" title="Logs and Outputs">
    <collapsible-list-item body>
      <div class="container">
        <div class="col-md-9 ">
          <div *ngIf="hasRunningSession()">
            <i class="fa fa-circle-o-notch fa-spin spin-icon" aria-hidden="true"></i>
          </div>
          <ul>
            <li *ngFor="let runningMessage of clusterMessages">{{ runningMessage }}</li>
          </ul> 
        </div>
      </div>
    </collapsible-list-item>
  
  </collapsible-list-fabric>
</div>