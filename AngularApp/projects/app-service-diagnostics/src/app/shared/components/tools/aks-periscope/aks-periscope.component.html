<div class="container">
  <h2 tabindex="0">AKS Periscope</h2>
  <p class="category-description" tabindex="0">
    AKS Periscope allows AKS customers to collect and export the logs into an Azure Blob storage account
    to help analyze and identify potential problems or easily share the information to support to help 
    with the troubleshooting process. 
    <a target="_blank" rel="noopener" href="https://github.com/Azure/aks-periscope">Learn more</a>
  </p>
  
  <p>
    The diagnostic tool uses <code>runCommand</code> which is only available for AKS clusters with Azure AD enabled.
    <a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/azure/aks/command-invoke">Learn more</a>
  </p>

  <p>
    Periscope requires a storage account to store the logs. If you do not own the storage account, you can specify a SAS token. The SAS token for your storage account using the Azure portal or Azure CLI.
    <span style="margin-top:5px"><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/azure/storage/common/storage-sas-overview">Learn more</a></span>
  </p>
  
  <p>
    Read our data privacy statement here.
    <a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/azure/aks/command-invoke">Learn more</a>
  </p>

  <div style="margin-top:10px;margin-bottom: 5px">
    <div *ngIf="status === toolStatus.Loading">
      <i class="fa fa-circle-o-notch fa-spin spin-icon" aria-hidden="true">Running </i>
    </div>
    <div *ngIf=" status === toolStatus.Error">
      <i class="fa health-icon fa-times-circle unhealthy-icon-color" aria-hidden="true">Error</i>
    </div>
    <div>
      <ul>
        <li *ngFor="let toolMessage of toolMessages">{{ toolMessage }}</li>
      </ul> 
    </div>
  </div>  

  <collapsible-list-fabric [collapsed]="false" title="Configure new Session">
    <!--configure periscope run-->
    <collapsible-list-item body>
      <div class="row">
        <div class="col-md-3 field-label"> Storage account Name<span class="required">*</span>
          <fab-tooltip-host
            content="The selected storage account will store the logs captured via AKS periscope. You can choose to use a storage account resource you own, 
            or an account with a shared access signature token"
            [directionalHint]="directionalHint" [tooltipOptions]="toolTipOptionsValue">
            <img src="assets/img/info.svg" title="storage-account"/>
          </fab-tooltip-host>
        </div>

        <div class="col-md-5">
          <span>{{ storageConfig.resourceName }}</span>
          <!-- <a tabindex="0" aria-label="choose account" (onClick)="openSelectStorageAccountBlade()" > Choose </a> -->
        </div>
      </div>

      <div class="row">
        <div class="col-md-3 field-label">
          <label for="chooseDiagSettings">Use Diagnostic Settings</label>
        </div>     
        <div class="col-md-5 col-sm-4" *ngIf="diagnosticSettings.length > 0; else noDiagSettings">
          <select  class="form-control form-control-sm"  id="chooseDiagSettings"  (change)="onDiagSettingSelectionChange()" [(ngModel)]="diagnosticSettingSelected">
            <option *ngFor="let diagSetting of diagnosticSettings" [ngValue]="diagSetting" > {{ diagSetting.name }}</option>
          </select>
        </div>
        <ng-template #noDiagSettings> 
          <div class="col-md-5 col-sm-4">
            <span>No existing diagnostic settings.</span> 
            <a tabindex="0" aria-label="create new settings" (onClick)="openCreateDiagnosticSettingsBlade()"> Create new </a>
          </div>
        </ng-template>
      </div>

      <div class="row">
        <div class="col-md-3 field-label">
          <label for="chooseStorageAccount">Choose Storage Account</label>
        </div>
        <div class="col-md-5 col-sm-4">
          <input id="chooseStorageAccount" class="form-control form-control-sm"  aria-required="false" placeholder="storage account resourceId" (change)="onStorageAccountResourceUriChange($event.target.value)" [(ngModel)]="storageAccountUri">
          <a tabindex="0" aria-label="choose storage account"> Create or Choose </a>
        </div>
      </div>

      <div class="row">
        <div class="col-md-3 field-label"> Storage Account SAS Key
          <fab-tooltip-host content="If you do not own the storage account specified above, you can specify a SAS token to access the storage account."
            [directionalHint]="directionalHint" [tooltipOptions]="toolTipOptionsValue">
            <img src="assets/img/info.svg" title="info" />
          </fab-tooltip-host>
        </div>
        <div class="col-md-5 col-sm-4">
          <input type="text"  class="form-control form-control-sm"  aria-required="false" placeholder="sas token" [(ngModel)]="storageConfig.accountSasToken">
        </div>
      </div>
      
      <div class="row">
        <div class="col-md-3 field-label"> Container Name <span class="required">*</span>
          <fab-tooltip-host content="The blob container to store the logs of Periscope.  The container will be created if not exists."
            [directionalHint]="directionalHint" [tooltipOptions]="toolTipOptionsValue">
            <img src="assets/img/info.svg" title="info" />
          </fab-tooltip-host>
        </div>
        <div class="col-md-5 col-sm-4">
          <input aria-required="true" class="form-control form-control-sm"  placeholder="blob container name" [(ngModel)]="containerName">
        </div>
      </div>  
        
      <div class="row">
        <div class="col-md-3 field-label">Diagnostic RunId <span class="required">*</span>
          <fab-tooltip-host content="The ID of the run. It should be unique per Periscope deployment."
            [directionalHint]="directionalHint" [tooltipOptions]="toolTipOptionsValue">
            <img src="assets/img/info.svg" title="info" />
          </fab-tooltip-host>
        </div>
        <div class="col-md-5 col-sm-4">
          <input aria-required="true" class="form-control form-control-sm"  placeholder="e.g., YYYY-DD-MMTHH:mm:SS" [(ngModel)]="diagnosticRunId">
        </div>
      </div> 

      <div class="mt-3 ml-3">
        <fab-primary-button [contentStyle]="'margin-right:10px;float:left'" [disabled]="!isValidStorageConfig() || isProcessingNewSession()" (onClick)="runInClusterPeriscope()">
          {{!isValidStorageConfig() || isProcessingNewSession() ? 'Submitting session to cluster' : 'Run Periscope in Cluster'  }}
        </fab-primary-button>
      </div>
    </collapsible-list-item>
  </collapsible-list-fabric>

  <collapsible-list-fabric [collapsed]="periscopeSessions.length === 0" title="Historical Sessions">
    <collapsible-list-item body>
      <div class="container">
        <div class="row">
          <div class="col-md-9">
            <div *ngIf="periscopeSessions.length === 0 else toolSessions">
              <fab-tooltip-host content="Only sessions available to AKS are displayed here" [directionalHint]="directionalHint" [tooltipOptions]="toolTipOptionsValue">
                No known sessions.
              </fab-tooltip-host>
            </div>

            <ng-template #toolSessions>
              <table class="table table-borderless">
                <thead>
                  <tr>
                    <th tabindex="0">Runtime/ Diagnostic Id</th>
                    <th tabindex="0">Running Status</th>
                    <th tabindex="0">View in Blob Container</th>
                    <th tabindex="0">Share With AKS
                      <fab-tooltip-host content="You can share with session result with AKS by generating a SAS token. You can specify an expiry date for the SAS token."
                      [directionalHint]="directionalHint" [tooltipOptions]="toolTipOptionsValue">
                      <img src="assets/img/info.svg" title="info" />
                    </fab-tooltip-host>
                    </th>
                  </tr>
                </thead>
                <tbody>
                  <tr *ngFor="let session of periscopeSessions">
                    <td tabindex="0"> {{ session.config.diagnosticRunId }} </td>
                    <td>
                      <div *ngIf="session.status === sessionStatus.Running">
                        <i class="fa fa-spinner fa-spin"></i> Running...
                      </div>
                      <div *ngIf="(session.status === sessionStatus.Error)">
                        <i class="fa health-icon fa-times-circle unhealthy-icon-color" aria-hidden="true"></i>
                        <span> Timeout retrieving runCommand status. The job might still be running</span>
                      </div>
                      <div *ngIf="session.status === sessionStatus.Finsihed">
                        <i class="fa health-icon fa-times-circle" aria-hidden="true"></i>
                        <span> Completed</span>
                      </div>
                      <div *ngIf="(session.status === sessionStatus.Error || session.status === sessionStatus.Finished)" (click)="getPeriscopeLogs(session)">
                        <a tabindex="0" aria-label="view logs"> Get logs </a> 
                      </div>
                    </td>
                    <td>
                      <div *ngIf="(session.status !== sessionStatus.Running && session.status !== sessionStatus.Created)" (click)="openStorageContainerBlade(session)">
                        <a tabindex="0" aria-label="view result">{{ session.config.containerName }} </a>
                      </div>
                    </td>
                    <td>
                      <div class="col-md-3" *ngIf="session.status === sessionStatus.Finished">
                        <select class="form-select form-select-sm ml-2" title="SAS Expiry" [(ngModel)]="session.sasExpiry">
                          <option *ngFor="let expiry of expirySettings" [ngValue]="expiry.value" > {{ expiry.displayName }}</option>
                        </select>
                        <a tabindex="0" aria-label="share with AKS" (click)="sharePeriscopeSessionWithAKS(session)"> Send </a>
                      </div>
                    </td>
                  </tr>
                </tbody>
              </table>
            </ng-template>
          </div>
        </div>
      </div>
    </collapsible-list-item>
  </collapsible-list-fabric>

  <collapsible-list-fabric [collapsed]="clusterMessages.length === 0" title="Logs and Outputs">
    <collapsible-list-item body>
      <div class="container">
        <div class="col-md-9 ">
          <div *ngIf="hasRunningSession()">
            <i class="fa fa-circle-o-notch fa-spin spin-icon" aria-hidden="true"></i>
          </div>
          <ul>
            <li *ngFor="let runningMessage of clusterMessages">{{ runningMessage }}</li>
          </ul> 
        </div>
      </div>
    </collapsible-list-item>
  
  </collapsible-list-fabric>
</div>